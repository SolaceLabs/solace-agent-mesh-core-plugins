# Plugin Metadata:
# Name: sam-nuclia-agent
# Version: 0.1.0
# Description: A plugin that enables agents to connect to the Nuclia RAG platform
# Author: SolaceLabs <solacelabs@solace.com>
# 
# --- Start of Agent Configuration Template ---
# Solace Agent Mesh: Plugin Configuration Template
#
# This file serves as a template for creating new agent configurations from this plugin.
# Use placeholders like __COMPONENT_KEBAB_CASE_NAME__, __COMPONENT_PASCAL_CASE_NAME__,
# and __COMPONENT_UPPER_SNAKE_CASE_NAME__ where the specific component name should be inserted.

log:
  stdout_log_level: INFO
  log_file_level: DEBUG
  log_file: __COMPONENT_KEBAB_CASE_NAME__.log

# To use the `shared_config.yaml` file, uncomment the following line and remove the `shared_config` section below.
# !include ../shared_config.yaml
shared_config:
  - broker_connection: &broker_connection
      dev_mode: ${SOLACE_DEV_MODE, false}
      broker_url: ${SOLACE_BROKER_URL, ws://localhost:8008}
      broker_username: ${SOLACE_BROKER_USERNAME, default}
      broker_password: ${SOLACE_BROKER_PASSWORD, default}
      broker_vpn: ${SOLACE_BROKER_VPN, default}
      temporary_queue: ${USE_TEMPORARY_QUEUES, true}

  - models:
    general: &general_model
      # This dictionary structure tells ADK to use the LiteLlm wrapper.
      # 'model' uses the specific model identifier your endpoint expects.
      model: ${LLM_SERVICE_GENERAL_MODEL_NAME} # Use env var for model name
      # 'api_base' tells LiteLLM where to send the request.
      api_base: ${LLM_SERVICE_ENDPOINT} # Use env var for endpoint URL
      # 'api_key' provides authentication.
      api_key: ${LLM_SERVICE_API_KEY} # Use env var for API key

  - services:
    # Default session service configuration
    session_service: &default_session_service
      type: "memory"
      default_behavior: "PERSISTENT"
    
    # Default artifact service configuration
    artifact_service: &default_artifact_service
      type: "filesystem"
      base_path: "/tmp/samv2"
      artifact_scope: namespace # Or "namespace", "app", "custom"

apps:
  - name: __COMPONENT_KEBAB_CASE_NAME__-app
    app_base_path: . 
    app_module: solace_agent_mesh.agent.sac.app 
    broker:
      <<: *broker_connection

    # App Level Config
    app_config:
      namespace: ${NAMESPACE} 
      supports_streaming: true 
      agent_name: "__COMPONENT_PASCAL_CASE_NAME__" 
      display_name: "__COMPONENT_SPACED_CAPITALIZED_NAME__ Agent"
      model: *general_model 

      instruction: |
        You are the __COMPONENT_SPACED_CAPITALIZED_NAME__ agent, designed to provide accurate answers using the Nuclia RAG platform.

        **Your workflow:**
        1. **Query Processing**: When a user asks a question, use the `generate_answer_with_citations` tool with their original query as the `query` parameter.
        
        2. **Answer Presentation**: The tool returns a `response_artifact` containing the complete, final answer with citations. Present this artifact exactly as returned using the artifact embed format below. Do not modify, summarize, or add commentary to the response.

        **Required response format:**
        ```markdown
        «artifact_content:{{response_artifact.filename}}:{{response_artifact.version}}»
        ```

        Always use the tool for information retrieval and present results using the artifact embed format.

      tools:
        # Example configuration for a RAG tool connecting to Nuclia
        - tool_type: python
          component_module: sam_nuclia_agent.nuclia_rag_tool
          class_name: NucliaRagTool
          tool_config:
            # --- Nuclia Connection Details ---
            base_url: ${NUCLIA_BASE_URL}
            kb_id: ${NUCLIA_KB_ID}
            token: ${NUCLIA_USER_TOKEN}
            api_key: ${NUCLIA_API_KEY}

            # --- Performance & Cost Control ---
            top_k: ${NUCLIA_TOP_K}

            # --- Artifact Configuration ---
            output_filename_base: "nuclia_answer"
            artifact_description_query_max_length: 150
            inline_citation_links: true

            # --- Dynamic Prompt/Context Configuration ---
            prompt_rephrasing:
              template: |
                <context>
                Consider the user's {region} and focus on {category} related information when answering the question.
                </context>

                <query>
                {query}
                </query>

            template_parameters:
              - name: "region"
                description: "Geographic region or location context for the query"
                type: "string"
                required: false
                nullable: true
                default: ""
              - name: "category"
                description: "Document category or type to focus the search"
                type: "string"
                required: false
                nullable: true
                default: ""
              - name: "user_id"
                description: "User ID extracted from context for audit logging"
                type: "string"
                context_expression: a2a_user_config.user_profile.id
                required: false
                nullable: true
                default: ""

            filter_expression_template:
              field:
                or:
                  - prop: label
                    labelset: "category"
                    label: "{category}"
                  - not:
                      prop: label
                      labelset: "category"

            audit_metadata:
              enabled: true
              fields:
                region: "{region}"
                category: "{category}"
                user_id: "{user_id}"

        - group_name: artifact_management
          tool_type: builtin-group

      session_service: *default_session_service
      artifact_service: *default_artifact_service

      artifact_handling_mode: "reference"
      enable_embed_resolution: true
      enable_artifact_content_instruction: true

      agent_card:
        description: "An agent that enables agents to connect to the Nuclia RAG platform"
        defaultInputModes: ["text"]
        defaultOutputModes: ["text"]
        skills:
         - id: generate_answer_with_citations
           name: "Generate Answer with Citations"
           description: "Generates an answer to a user query using retrieved documents and provides citations."

      agent_card_publishing: { interval_seconds: 10 }
      agent_discovery: { enabled: false }
      inter_agent_communication:
        allow_list: []
        request_timeout_seconds: 30