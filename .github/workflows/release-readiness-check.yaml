name: Release Readiness Check

# This workflow validates that all security checks pass before release.
# It can be called from release-please workflow or triggered manually.

on:
  workflow_call:
    inputs:
      pr_number:
        description: "PR number to comment on"
        required: true
        type: number
      ref:
        description: "Git ref to checkout (branch or SHA)"
        required: false
        type: string
        default: ""
    secrets:
      FOSSA_API_KEY:
        required: true
      SONARQUBE_TOKEN:
        required: true
      SONARQUBE_HOST_URL:
        required: true
  workflow_dispatch:
    inputs:
      pr_number:
        description: "PR number to comment on (optional)"
        required: false
        type: number
      ref:
        description: "Git ref to checkout (branch or SHA)"
        required: false
        type: string
        default: ""

permissions:
  contents: read
  pull-requests: write
  checks: write
  statuses: write

jobs:
  # First job: Extract plugins being released
  extract-plugins:
    name: Extract Plugins
    runs-on: ubuntu-latest
    outputs:
      plugins: ${{ steps.extract.outputs.plugins }}
      plugins_json: ${{ steps.extract.outputs.plugins_json }}
    steps:
      - name: Checkout code
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          ref: ${{ inputs.ref || github.ref }}
          fetch-depth: 0

      - name: Extract plugins being released
        id: extract
        run: |
          # Get the changed files by comparing against main
          git fetch origin main
          CHANGED_FILES=$(git diff --name-only origin/main...HEAD)
          echo "Changed files:"
          echo "$CHANGED_FILES"

          # Extract unique plugin directories from changed files
          PLUGINS=$(echo "$CHANGED_FILES" | grep -E '^sam-[^/]+/' | cut -d'/' -f1 | sort -u | tr '\n' ',' | sed 's/,$//')
          echo "Plugins being released: $PLUGINS"
          echo "plugins=$PLUGINS" >> $GITHUB_OUTPUT

          # Create JSON array for matrix
          if [ -z "$PLUGINS" ]; then
            echo "plugins_json=[]" >> $GITHUB_OUTPUT
          else
            JSON="["
            FIRST=true
            IFS=',' read -ra PLUGIN_ARRAY <<< "$PLUGINS"
            for plugin in "${PLUGIN_ARRAY[@]}"; do
              plugin=$(echo "$plugin" | xargs)
              if [ -z "$plugin" ]; then continue; fi
              if [ "$FIRST" = true ]; then FIRST=false; else JSON="$JSON,"; fi
              JSON="$JSON\"$plugin\""
            done
            JSON="$JSON]"
            echo "plugins_json=$JSON" >> $GITHUB_OUTPUT
          fi

  # Second job: Check SonarQube hotspots for each plugin
  sonarqube-check:
    name: SonarQube - ${{ matrix.plugin }}
    needs: extract-plugins
    if: needs.extract-plugins.outputs.plugins_json != '[]'
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        plugin: ${{ fromJSON(needs.extract-plugins.outputs.plugins_json) }}
    steps:
      - name: Check SonarQube Hotspots for ${{ matrix.plugin }}
        id: sonarqube
        uses: SolaceDev/maas-build-actions/.github/actions/sonarqube-hotspot-checker@master
        continue-on-error: true
        with:
          sonarqube_project: "${{ github.repository_owner }}_${{ matrix.plugin }}"
          branch: "main"

      - name: Record result
        if: always()
        run: |
          echo "Plugin: ${{ matrix.plugin }}"
          echo "Status: ${{ steps.sonarqube.outcome }}"

  # Third job: Check FOSSA for the entire repository
  fossa-check:
    name: FOSSA Check
    needs: extract-plugins
    runs-on: ubuntu-latest
    steps:
      - name: FOSSA Licensing Check
        id: fossa_licensing
        uses: SolaceDev/solace-public-workflows/.github/actions/fossa-guard@main
        continue-on-error: true
        with:
          fossa_api_key: ${{ secrets.FOSSA_API_KEY }}
          fossa_project_id: "${{ github.repository_owner }}_${{ github.event.repository.name }}"
          fossa_branch: main
          fossa_revision: ${{ github.sha }}
          fossa_category: licensing
          fossa_mode: BLOCK
          block_on: policy_conflict

      - name: FOSSA Vulnerability Check
        id: fossa_vulnerabilities
        uses: SolaceDev/solace-public-workflows/.github/actions/fossa-guard@main
        continue-on-error: true
        with:
          fossa_api_key: ${{ secrets.FOSSA_API_KEY }}
          fossa_project_id: "${{ github.repository_owner }}_${{ github.event.repository.name }}"
          fossa_branch: main
          fossa_revision: ${{ github.sha }}
          fossa_category: vulnerability
          fossa_mode: BLOCK
          block_on: critical,high

      - name: Record result
        if: always()
        run: |
          echo "Licensing Status: ${{ steps.fossa_licensing.outcome }}"
          echo "Vulnerability Status: ${{ steps.fossa_vulnerabilities.outcome }}"

  # Fourth job: Aggregate results and comment on PR
  report-results:
    name: Report Results
    needs: [extract-plugins, sonarqube-check, fossa-check]
    if: always()
    runs-on: ubuntu-latest
    steps:
      - name: Create Check Summary
        run: |
          echo "## ðŸ” Release Readiness Check Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          PLUGINS="${{ needs.extract-plugins.outputs.plugins }}"
          SONAR_RESULT="${{ needs.sonarqube-check.result }}"
          FOSSA_RESULT="${{ needs.fossa-check.result }}"

          echo "### SonarQube Hotspots (Per-Plugin)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "$SONAR_RESULT" = "success" ]; then
            echo "âœ… **All plugins passed** - No unresolved HIGH vulnerability hotspots" >> $GITHUB_STEP_SUMMARY
          elif [ "$SONAR_RESULT" = "skipped" ]; then
            echo "â­ï¸ **Skipped** - No plugins to check" >> $GITHUB_STEP_SUMMARY
          else
            echo "âš ï¸ **Some plugins have issues** - Check individual job results above" >> $GITHUB_STEP_SUMMARY
          fi

          if [ -n "$PLUGINS" ]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "| Plugin | Project |" >> $GITHUB_STEP_SUMMARY
            echo "|--------|---------|" >> $GITHUB_STEP_SUMMARY
            IFS=',' read -ra PLUGIN_ARRAY <<< "$PLUGINS"
            for plugin in "${PLUGIN_ARRAY[@]}"; do
              plugin=$(echo "$plugin" | xargs)
              echo "| \`$plugin\` | SolaceLabs_${plugin} |" >> $GITHUB_STEP_SUMMARY
            done
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### FOSSA Checks (Repository-Level)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Check | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY

          if [ "$FOSSA_RESULT" = "success" ]; then
            echo "| Licensing | âœ… Passed |" >> $GITHUB_STEP_SUMMARY
            echo "| Vulnerabilities | âœ… Passed |" >> $GITHUB_STEP_SUMMARY
          elif [ "$FOSSA_RESULT" = "skipped" ]; then
            echo "| Licensing | â­ï¸ Skipped |" >> $GITHUB_STEP_SUMMARY
            echo "| Vulnerabilities | â­ï¸ Skipped |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| Licensing | âš ï¸ Check job results |" >> $GITHUB_STEP_SUMMARY
            echo "| Vulnerabilities | âš ï¸ Check job results |" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Plugins Being Released" >> $GITHUB_STEP_SUMMARY
          if [ -n "$PLUGINS" ]; then
            IFS=',' read -ra PLUGIN_ARRAY <<< "$PLUGINS"
            for plugin in "${PLUGIN_ARRAY[@]}"; do
              echo "- \`$plugin\`" >> $GITHUB_STEP_SUMMARY
            done
          else
            echo "- No specific plugins detected" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Comment on PR
        if: inputs.pr_number
        uses: actions/github-script@f28e40c7f34bde8b3046d885e986cb6290c5673b # v7.1.0
        with:
          script: |
            const prNumber = ${{ inputs.pr_number }};
            const pluginsToRelease = '${{ needs.extract-plugins.outputs.plugins }}';
            const sonarResult = '${{ needs.sonarqube-check.result }}';
            const fossaResult = '${{ needs.fossa-check.result }}';

            const getStatusEmoji = (status) => {
              if (status === 'success') return 'âœ…';
              if (status === 'skipped') return 'â­ï¸';
              return 'âš ï¸';
            };

            const getSonarStatusText = (status) => {
              if (status === 'success') return 'All plugins passed';
              if (status === 'skipped') return 'Skipped (no plugins)';
              return 'Some plugins have issues';
            };

            const getFossaStatusText = (status) => {
              if (status === 'success') return 'Passed';
              if (status === 'skipped') return 'Skipped';
              return 'Issues found';
            };

            let pluginsList = 'None detected';
            let pluginsTable = '';
            if (pluginsToRelease) {
              const plugins = pluginsToRelease.split(',').map(p => p.trim()).filter(p => p);
              pluginsList = plugins.map(p => `\`${p}\``).join(', ');
              
              pluginsTable = [
                '',
                '### SonarQube Projects Checked',
                '',
                '| Plugin | SonarQube Project |',
                '|--------|-------------------|',
                ...plugins.map(p => `| \`${p}\` | SolaceLabs_${p} |`),
                ''
              ].join('\n');
            }

            const body = [
              '## ðŸ” Release Readiness Check Results',
              '',
              '### Overall Status',
              '',
              '| Check | Scope | Status |',
              '|-------|-------|--------|',
              `| SonarQube Hotspots | Per-Plugin | ${getStatusEmoji(sonarResult)} ${getSonarStatusText(sonarResult)} |`,
              `| FOSSA Licensing | Repository | ${getStatusEmoji(fossaResult)} ${getFossaStatusText(fossaResult)} |`,
              `| FOSSA Vulnerabilities | Repository | ${getStatusEmoji(fossaResult)} ${getFossaStatusText(fossaResult)} |`,
              pluginsTable,
              '### Plugins Being Released',
              pluginsList,
              '',
              '---',
              '*This check runs automatically on release-please PRs to ensure compliance before release.*',
              '*Click on individual job results above for detailed per-plugin SonarQube status.*'
            ].join('\n');

            // Find and delete existing comment
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
            });

            const botComment = comments.find(comment => 
              comment.user.type === 'Bot' && 
              comment.body.includes('Release Readiness Check Results')
            );

            if (botComment) {
              console.log(`Deleting existing comment ${botComment.id}`);
              await github.rest.issues.deleteComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id
              });
            }

            // Create new comment
            console.log(`Creating new comment on PR #${prNumber}`);
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
              body: body
            });
