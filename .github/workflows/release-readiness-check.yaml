name: Release Readiness Check

# This workflow runs on release-please PRs to validate that all security checks pass
# before the release PR can be merged. This ensures that releases are only made
# when all compliance requirements are met.

on:
  pull_request:
    types: [opened, synchronize, reopened]
    branches:
      - main

permissions:
  contents: read
  pull-requests: write
  checks: write
  statuses: write

jobs:
  # Check if this is a release-please PR
  check-release-pr:
    name: Check if Release PR
    runs-on: ubuntu-latest
    outputs:
      is_release_pr: ${{ steps.check.outputs.is_release_pr }}
      plugins_to_release: ${{ steps.extract.outputs.plugins }}
    steps:
      - name: Check if release PR
        id: check
        run: |
          # Check if PR title matches release-please format
          PR_TITLE="${{ github.event.pull_request.title }}"
          echo "PR Title: $PR_TITLE"

          # Release-please PRs have title format: "chore: release main" or "chore(main): release <version>"
          if echo "$PR_TITLE" | grep -qiE "^chore(\(.*\))?: release"; then
            echo "is_release_pr=true" >> $GITHUB_OUTPUT
            echo "This is a release-please PR"
          else
            echo "is_release_pr=false" >> $GITHUB_OUTPUT
            echo "This is NOT a release-please PR"
          fi

      - name: Checkout code
        if: steps.check.outputs.is_release_pr == 'true'
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          fetch-depth: 0

      - name: Extract plugins being released
        id: extract
        if: steps.check.outputs.is_release_pr == 'true'
        run: |
          # Get the changed files in this PR to determine which plugins are being released
          CHANGED_FILES=$(git diff --name-only origin/main...HEAD)
          echo "Changed files in PR:"
          echo "$CHANGED_FILES"

          # Extract unique plugin directories from changed files
          PLUGINS=$(echo "$CHANGED_FILES" | grep -E '^sam-[^/]+/' | cut -d'/' -f1 | sort -u | tr '\n' ',' | sed 's/,$//')
          echo "Plugins being released: $PLUGINS"
          echo "plugins=$PLUGINS" >> $GITHUB_OUTPUT

  # Run release readiness checks for release-please PRs
  release-readiness-check:
    name: Release Readiness Check
    needs: check-release-pr
    if: needs.check-release-pr.outputs.is_release_pr == 'true'
    runs-on: ubuntu-latest
    outputs:
      SONARQUBE_STATUS: ${{ steps.security_outputs.outputs.sonarqube_status }}
      FOSSA_POLICY_STATUS: ${{ steps.security_outputs.outputs.fossa_policy_status }}
      FOSSA_VULNERABILITIES_STATUS: ${{ steps.security_outputs.outputs.fossa_vulnerabilities_status }}
    steps:
      - name: Checkout code
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          fetch-depth: 0

      - name: Pre-Release Check - Unresolved SonarQube Hotspots
        id: sonarqube_hotspots
        uses: SolaceDev/maas-build-actions/.github/actions/sonarqube-hotspot-checker@master
        continue-on-error: true
        with:
          sonarqube_project: "${{ github.repository_owner }}_${{ github.event.repository.name }}"
          branch: "main"

      - name: Pre-Release Check - FOSSA Licensing
        id: fossa_licensing
        uses: SolaceDev/solace-public-workflows/.github/actions/fossa-guard@main
        continue-on-error: true
        with:
          fossa_api_key: ${{ secrets.FOSSA_API_KEY }}
          fossa_project_id: "${{ github.repository_owner }}_${{ github.event.repository.name }}"
          fossa_branch: main
          fossa_revision: ${{ github.event.pull_request.head.sha }}
          fossa_category: licensing
          fossa_mode: BLOCK
          block_on: policy_conflict

      - name: Pre-Release Check - FOSSA Security Vulnerabilities
        id: fossa_vulnerabilities
        uses: SolaceDev/solace-public-workflows/.github/actions/fossa-guard@main
        continue-on-error: true
        with:
          fossa_api_key: ${{ secrets.FOSSA_API_KEY }}
          fossa_project_id: "${{ github.repository_owner }}_${{ github.event.repository.name }}"
          fossa_branch: main
          fossa_revision: ${{ github.event.pull_request.head.sha }}
          fossa_category: vulnerability
          fossa_mode: BLOCK
          block_on: critical,high

      - name: Set security check outputs
        id: security_outputs
        run: |
          echo "sonarqube_status=${{ steps.sonarqube_hotspots.outcome }}" >> $GITHUB_OUTPUT
          echo "fossa_policy_status=${{ steps.fossa_licensing.outcome }}" >> $GITHUB_OUTPUT
          echo "fossa_vulnerabilities_status=${{ steps.fossa_vulnerabilities.outcome }}" >> $GITHUB_OUTPUT

      - name: Create Check Summary
        if: always()
        run: |
          echo "## ðŸ” Release Readiness Check Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Check | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY

          # SonarQube status
          if [ "${{ steps.sonarqube_hotspots.outcome }}" = "success" ]; then
            echo "| SonarQube Hotspots | âœ… Passed |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| SonarQube Hotspots | âš ï¸ ${{ steps.sonarqube_hotspots.outcome }} |" >> $GITHUB_STEP_SUMMARY
          fi

          # FOSSA Licensing status
          if [ "${{ steps.fossa_licensing.outcome }}" = "success" ]; then
            echo "| FOSSA Licensing | âœ… Passed |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| FOSSA Licensing | âš ï¸ ${{ steps.fossa_licensing.outcome }} |" >> $GITHUB_STEP_SUMMARY
          fi

          # FOSSA Vulnerabilities status
          if [ "${{ steps.fossa_vulnerabilities.outcome }}" = "success" ]; then
            echo "| FOSSA Vulnerabilities | âœ… Passed |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| FOSSA Vulnerabilities | âš ï¸ ${{ steps.fossa_vulnerabilities.outcome }} |" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Plugins being released:** ${{ needs.check-release-pr.outputs.plugins_to_release }}" >> $GITHUB_STEP_SUMMARY

      - name: Comment on PR with check results
        if: always()
        uses: actions/github-script@f28e40c7f34bde8b3046d885e986cb6290c5673b # v7.1.0
        with:
          script: |
            const sonarqubeStatus = '${{ steps.sonarqube_hotspots.outcome }}';
            const fossaLicensingStatus = '${{ steps.fossa_licensing.outcome }}';
            const fossaVulnerabilitiesStatus = '${{ steps.fossa_vulnerabilities.outcome }}';
            const pluginsToRelease = '${{ needs.check-release-pr.outputs.plugins_to_release }}';

            const getStatusEmoji = (status) => status === 'success' ? 'âœ…' : 'âš ï¸';

            const body = `## ðŸ” Release Readiness Check Results

            | Check | Status |
            |-------|--------|
            | SonarQube Hotspots | ${getStatusEmoji(sonarqubeStatus)} ${sonarqubeStatus} |
            | FOSSA Licensing | ${getStatusEmoji(fossaLicensingStatus)} ${fossaLicensingStatus} |
            | FOSSA Vulnerabilities | ${getStatusEmoji(fossaVulnerabilitiesStatus)} ${fossaVulnerabilitiesStatus} |

            **Plugins being released:** ${pluginsToRelease || 'None detected'}

            ---
            *This check runs automatically on release-please PRs to ensure compliance before release.*`;

            // Find existing comment
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });

            const botComment = comments.find(comment => 
              comment.user.type === 'Bot' && 
              comment.body.includes('Release Readiness Check Results')
            );

            if (botComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: body
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: body
              });
            }

  # Status check for non-release PRs (skip)
  release-readiness-skip:
    name: Release Readiness Check
    needs: check-release-pr
    if: needs.check-release-pr.outputs.is_release_pr != 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Skip release readiness check
        run: |
          echo "This is not a release-please PR, skipping release readiness checks"
          echo "PR Title: ${{ github.event.pull_request.title }}"
