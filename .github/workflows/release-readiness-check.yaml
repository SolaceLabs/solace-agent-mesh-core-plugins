name: Release Readiness Check

# This workflow validates that all security checks pass before release.
# It can be called from release-please workflow or triggered manually.

on:
  workflow_call:
    inputs:
      pr_number:
        description: "PR number to comment on"
        required: true
        type: number
      ref:
        description: "Git ref to checkout (branch or SHA)"
        required: false
        type: string
        default: ""
    secrets:
      FOSSA_API_KEY:
        required: true
      SONARQUBE_TOKEN:
        required: false
      SONARQUBE_HOST_URL:
        required: false
  workflow_dispatch:
    inputs:
      pr_number:
        description: "PR number to comment on (optional)"
        required: false
        type: number
      ref:
        description: "Git ref to checkout (branch or SHA)"
        required: false
        type: string
        default: ""

permissions:
  contents: read
  pull-requests: write
  checks: write
  statuses: write

jobs:
  release-readiness-check:
    name: Release Readiness Check
    runs-on: ubuntu-latest
    outputs:
      SONARQUBE_STATUS: ${{ steps.security_outputs.outputs.sonarqube_status }}
      FOSSA_POLICY_STATUS: ${{ steps.security_outputs.outputs.fossa_policy_status }}
      FOSSA_VULNERABILITIES_STATUS: ${{ steps.security_outputs.outputs.fossa_vulnerabilities_status }}
      PLUGINS: ${{ steps.extract.outputs.plugins }}
    steps:
      - name: Checkout code
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          ref: ${{ inputs.ref || github.ref }}
          fetch-depth: 0

      - name: Get current GitHub SHA
        id: get_sha
        run: echo "sha=${GITHUB_SHA}" >> $GITHUB_OUTPUT
      - name: Extract plugins being released
        id: extract
        run: |
          # Get the changed files by comparing against main
          git fetch origin main
          CHANGED_FILES=$(git diff --name-only origin/main...HEAD)
          echo "Changed files:"
          echo "$CHANGED_FILES"

          # Extract unique plugin directories from changed files
          PLUGINS=$(echo "$CHANGED_FILES" | grep -E '^sam-[^/]+/' | cut -d'/' -f1 | sort -u | tr '\n' ',' | sed 's/,$//')
          echo "Plugins being released: $PLUGINS"
          echo "plugins=$PLUGINS" >> $GITHUB_OUTPUT

      - name: Pre-Release Check - Unresolved SonarQube Hotspots
        id: sonarqube_hotspots
        uses: SolaceDev/maas-build-actions/.github/actions/sonarqube-hotspot-checker@master
        continue-on-error: true
        with:
          sonarqube_project: "${{ github.repository_owner }}_${{ github.event.repository.name }}"
          branch: "main"

      - name: Pre-Release Check - FOSSA Licensing
        id: fossa_licensing
        uses: SolaceDev/solace-public-workflows/.github/actions/fossa-guard@main
        continue-on-error: true
        with:
          fossa_api_key: ${{ secrets.FOSSA_API_KEY }}
          fossa_project_id: "${{ github.repository_owner }}_${{ github.event.repository.name }}"
          fossa_branch: main
          fossa_revision: ${{ steps.get_sha.outputs.sha }}
          fossa_category: licensing
          fossa_mode: BLOCK
          block_on: policy_conflict

      - name: Pre-Release Check - FOSSA Security Vulnerabilities
        id: fossa_vulnerabilities
        uses: SolaceDev/solace-public-workflows/.github/actions/fossa-guard@main
        continue-on-error: true
        with:
          fossa_api_key: ${{ secrets.FOSSA_API_KEY }}
          fossa_project_id: "${{ github.repository_owner }}_${{ github.event.repository.name }}"
          fossa_branch: main
          fossa_revision: ${{ steps.get_sha.outputs.sha }}
          fossa_category: vulnerability
          fossa_mode: BLOCK
          block_on: critical,high

      - name: Set security check outputs
        id: security_outputs
        run: |
          echo "sonarqube_status=${{ steps.sonarqube_hotspots.outcome }}" >> $GITHUB_OUTPUT
          echo "fossa_policy_status=${{ steps.fossa_licensing.outcome }}" >> $GITHUB_OUTPUT
          echo "fossa_vulnerabilities_status=${{ steps.fossa_vulnerabilities.outcome }}" >> $GITHUB_OUTPUT

      - name: Create Check Summary
        if: always()
        run: |
          echo "## ðŸ” Release Readiness Check Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Check | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY

          # SonarQube status
          if [ "${{ steps.sonarqube_hotspots.outcome }}" = "success" ]; then
            echo "| SonarQube Hotspots | âœ… Passed |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| SonarQube Hotspots | âš ï¸ ${{ steps.sonarqube_hotspots.outcome }} |" >> $GITHUB_STEP_SUMMARY
          fi

          # FOSSA Licensing status
          if [ "${{ steps.fossa_licensing.outcome }}" = "success" ]; then
            echo "| FOSSA Licensing | âœ… Passed |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| FOSSA Licensing | âš ï¸ ${{ steps.fossa_licensing.outcome }} |" >> $GITHUB_STEP_SUMMARY
          fi

          # FOSSA Vulnerabilities status
          if [ "${{ steps.fossa_vulnerabilities.outcome }}" = "success" ]; then
            echo "| FOSSA Vulnerabilities | âœ… Passed |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| FOSSA Vulnerabilities | âš ï¸ ${{ steps.fossa_vulnerabilities.outcome }} |" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Plugins Being Released" >> $GITHUB_STEP_SUMMARY
          PLUGINS="${{ steps.extract.outputs.plugins }}"
          if [ -n "$PLUGINS" ]; then
            IFS=',' read -ra PLUGIN_ARRAY <<< "$PLUGINS"
            for plugin in "${PLUGIN_ARRAY[@]}"; do
              echo "- \`$plugin\`" >> $GITHUB_STEP_SUMMARY
            done
          else
            echo "- No specific plugins detected" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Comment on PR
        if: always() && inputs.pr_number
        uses: actions/github-script@f28e40c7f34bde8b3046d885e986cb6290c5673b # v7.1.0
        with:
          script: |
            const prNumber = ${{ inputs.pr_number }};
            const sonarqubeStatus = '${{ steps.sonarqube_hotspots.outcome }}';
            const fossaLicensingStatus = '${{ steps.fossa_licensing.outcome }}';
            const fossaVulnerabilitiesStatus = '${{ steps.fossa_vulnerabilities.outcome }}';
            const pluginsToRelease = '${{ steps.extract.outputs.plugins }}';

            const getStatusEmoji = (status) => status === 'success' ? 'âœ…' : 'âš ï¸';

            let pluginsList = 'None detected';
            if (pluginsToRelease) {
              pluginsList = pluginsToRelease.split(',').map(p => `\`${p}\``).join(', ');
            }

            const body = [
              '## ðŸ” Release Readiness Check Results',
              '',
              '| Check | Status |',
              '|-------|--------|',
              `| SonarQube Hotspots | ${getStatusEmoji(sonarqubeStatus)} ${sonarqubeStatus} |`,
              `| FOSSA Licensing | ${getStatusEmoji(fossaLicensingStatus)} ${fossaLicensingStatus} |`,
              `| FOSSA Vulnerabilities | ${getStatusEmoji(fossaVulnerabilitiesStatus)} ${fossaVulnerabilitiesStatus} |`,
              '',
              '### Plugins Being Released',
              pluginsList,
              '',
              '---',
              '*This check runs automatically on release-please PRs to ensure compliance before release.*'
            ].join('\n');

            // Find and delete existing comment
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
            });

            const botComment = comments.find(comment => 
              comment.user.type === 'Bot' && 
              comment.body.includes('Release Readiness Check Results')
            );

            if (botComment) {
              console.log(`Deleting existing comment ${botComment.id}`);
              await github.rest.issues.deleteComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id
              });
            }

            // Create new comment
            console.log(`Creating new comment on PR #${prNumber}`);
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
              body: body
            });
