name: Sync Plugin Configs

# This workflow runs when new plugin directories are added to ensure they are
# properly configured in all the necessary files.
#
# IMPORTANT: When adding a new plugin, also add it to paths-ignore below
# so this workflow doesn't trigger unnecessarily for that plugin anymore.
# The list should match the plugins in:
# - .github/workflows/build-plugin.yaml (workflow_dispatch options)
# - .release-please-manifest.json
# - release-please-config.json
# - .github/pr_labeler.yaml

on:
  pull_request:
    types: [opened, synchronize]
    paths:
      # Trigger on any sam-* directory changes
      - "sam-*/**"
      # Exclude existing plugins that are already configured
      # Keep this list in sync with build-plugin.yaml options
      - "!sam-bedrock-agent/**"
      - "!sam-event-mesh-agent/**"
      - "!sam-event-mesh-gateway/**"
      - "!sam-event-mesh-tool/**"
      - "!sam-geo-information/**"
      - "!sam-mcp-server-gateway-adapter/**"
      - "!sam-mermaid/**"
      - "!sam-mongodb/**"
      - "!sam-nuclia-tool/**"
      - "!sam-rag/**"
      - "!sam-rest-gateway/**"
      - "!sam-ruleset-lookup-tool/**"
      - "!sam-slack/**"
      - "!sam-slack-gateway-adapter/**"
      - "!sam-sql-database/**"
      - "!sam-sql-database-tool/**"
      - "!sam-webhook-gateway/**"

permissions:
  contents: write
  pull-requests: write

jobs:
  sync-configs:
    name: Sync Plugin Configurations
    runs-on: ubuntu-latest
    # Only run on PRs from the same repo (not forks) since we need push access
    if: github.event.pull_request.head.repo.full_name == github.repository
    steps:
      - name: Checkout code
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          ref: ${{ github.head_ref }}
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Python
        uses: actions/setup-python@a26af69be951a213d495a4c3e4e4022e16d87065 # v5.6.0
        with:
          python-version: "3.11"

      - name: Check for missing plugins
        id: check
        run: |
          python .github/scripts/check_plugins.py
          EXIT_CODE=$?
          if [ $EXIT_CODE -eq 0 ]; then
            echo "needs_update=false" >> $GITHUB_OUTPUT
          else
            echo "needs_update=true" >> $GITHUB_OUTPUT
          fi
          # Don't fail the step, we'll handle it below
          exit 0

      - name: Add missing plugins
        if: steps.check.outputs.needs_update == 'true'
        run: |
          python .github/scripts/add_missing_plugins.py

      - name: Check for changes
        id: changes
        if: steps.check.outputs.needs_update == 'true'
        run: |
          if git diff --quiet; then
            echo "has_changes=false" >> $GITHUB_OUTPUT
          else
            echo "has_changes=true" >> $GITHUB_OUTPUT
            echo "Changed files:"
            git diff --name-only
          fi

      - name: Commit and push changes
        if: steps.check.outputs.needs_update == 'true' && steps.changes.outputs.has_changes == 'true'
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add .
          git commit -m "chore: sync plugin configurations

          Automatically added missing plugin(s) to:
          - .github/workflows/build-plugin.yaml
          - .github/workflows/sync-plugin-configs.yaml
          - .release-please-manifest.json
          - release-please-config.json
          - .github/pr_labeler.yaml"
          git push

      - name: Comment on PR
        if: steps.check.outputs.needs_update == 'true' && steps.changes.outputs.has_changes == 'true'
        uses: actions/github-script@f28e40c7f34bde8b3046d885e986cb6290c5673b # v7.1.0
        with:
          script: |
            const body = `## ðŸ”„ Plugin Configuration Sync

            I detected new plugin directories and automatically updated the configuration files:
            - \`.github/workflows/build-plugin.yaml\`
            - \`.github/workflows/sync-plugin-configs.yaml\`
            - \`.release-please-manifest.json\`
            - \`release-please-config.json\`
            - \`.github/pr_labeler.yaml\`

            Please review the changes and ensure they are correct.`;

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: body
            });

      - name: Summary
        if: always()
        run: |
          echo "## Plugin Configuration Sync" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "${{ steps.check.outputs.needs_update }}" == "false" ]; then
            echo "âœ… All plugin configurations are already in sync." >> $GITHUB_STEP_SUMMARY
          elif [ "${{ steps.changes.outputs.has_changes }}" == "true" ]; then
            echo "âœ… Missing plugins were added to configuration files." >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "The following files were updated:" >> $GITHUB_STEP_SUMMARY
            echo "- \`.github/workflows/build-plugin.yaml\`" >> $GITHUB_STEP_SUMMARY
            echo "- \`.github/workflows/sync-plugin-configs.yaml\`" >> $GITHUB_STEP_SUMMARY
            echo "- \`.release-please-manifest.json\`" >> $GITHUB_STEP_SUMMARY
            echo "- \`release-please-config.json\`" >> $GITHUB_STEP_SUMMARY
            echo "- \`.github/pr_labeler.yaml\`" >> $GITHUB_STEP_SUMMARY
          else
            echo "â„¹ï¸ Check indicated updates needed but no file changes detected." >> $GITHUB_STEP_SUMMARY
          fi
